<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FIRE í”„ë¡¬í”„íŠ¸ í•™ìŠµ - LLM Classroom Proto3</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .main-container {
            width: 98%;
            max-width: 1800px;
            height: 90vh;
            display: flex;
            gap: 20px;
        }

        /* ì¢Œì¸¡: í•™ìŠµ ëª©í‘œ ì˜ì—­ */
        .objective-container {
            flex: 1.8;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .objective-header {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            padding: 20px;
            text-align: center;
            font-size: 1.3rem;
            font-weight: 600;
        }

        .objective-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8f9fa;
        }

        /* ì¤‘ì•™: ëŒ€í™” ì˜ì—­ */
        .chat-container {
            flex: 4;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-header {
            background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
            color: white;
            padding: 20px;
            text-align: center;
            font-size: 1.3rem;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .settings-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .chat-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8f9fa;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .chat-input-area {
            padding: 20px;
            background: white;
            border-top: 1px solid #e9ecef;
        }

        .input-group {
            display: flex;
            gap: 15px;
            align-items: flex-end;
        }

        .chat-input {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            font-size: 1rem;
            resize: none;
            min-height: 60px;
            max-height: 120px;
            outline: none;
            transition: border-color 0.3s ease;
            background: white;
        }

        .chat-input:focus {
            border-color: #ff6b35;
            box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
        }

        .send-btn {
            background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: transform 0.2s ease;
            white-space: nowrap;
        }

        .send-btn:hover:not(:disabled) {
            transform: translateY(-2px);
        }

        .send-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* í”„ë¡¬í”„íŠ¸-ì‘ë‹µ ìŒ */
        .conversation-pair {
            display: flex;
            flex-direction: column;
            gap: 15px;
            background: white;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #e9ecef;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .prompt-box {
            background: #fff5f0;
            border: 1px solid #ff6b35;
            border-radius: 8px;
            padding: 15px;
            border-left: 4px solid #ff6b35;
        }

        .response-box {
            background: #f0fff4;
            border: 1px solid #27ae60;
            border-radius: 8px;
            padding: 15px;
            border-left: 4px solid #27ae60;
        }

        .box-title {
            font-size: 1rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .box-content {
            color: #555;
            line-height: 1.6;
            white-space: pre-wrap;
        }

        .loading-response {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #666;
            font-style: italic;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
            font-size: 1.1rem;
        }

        .empty-state p {
            margin: 10px 0;
        }

        /* ìš°ì¸¡: í”¼ë“œë°± ì˜ì—­ */
        .feedback-container {
            flex: 2.2;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .feedback-header {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
            padding: 20px;
            text-align: center;
            font-size: 1.3rem;
            font-weight: 600;
            animation: pulse 2s ease-in-out infinite alternate;
        }

        @keyframes pulse {
            from { box-shadow: 0 0 10px rgba(240, 147, 251, 0.3); }
            to { box-shadow: 0 0 20px rgba(240, 147, 251, 0.6); }
        }

        .feedback-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8f9fa;
        }

        /* ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ */
        .message {
            display: flex;
            max-width: 80%;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message-content {
            padding: 15px 20px;
            border-radius: 20px;
            max-width: 100%;
            line-height: 1.4;
            word-wrap: break-word;
            font-size: 0.95rem;
        }

        .message.user .message-content {
            background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
            color: white;
            border-bottom-right-radius: 5px;
        }

        .message.ai .message-content {
            background: white;
            color: #333;
            border: 1px solid #e9ecef;
            border-bottom-left-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        /* FIRE ì ìˆ˜ í‘œì‹œ */
        .fire-scores {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
        }

        .rtcf-scores h3 {
            margin-bottom: 15px;
            color: #333;
            font-size: 1.1rem;
        }

        .score-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding: 8px 0;
            border-bottom: 1px solid #f1f3f4;
        }

        .score-item:last-child {
            border-bottom: none;
        }

        .score-name {
            font-weight: 600;
            color: #555;
        }

        .score-value {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .stars {
            color: #ffc107;
            font-size: 1.1rem;
        }

        .feedback-section {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #ff6b35;
        }

        .feedback-section h4 {
            color: #ff6b35;
            margin-bottom: 8px;
            font-size: 1rem;
        }

        .feedback-section p {
            color: #666;
            line-height: 1.4;
            font-size: 0.9rem;
        }

        .loading {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #666;
            font-style: italic;
            padding: 15px 0;
        }

        .loading-dots {
            display: flex;
            gap: 4px;
        }

        .loading-dots span {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ff6b35;
            animation: bounce 1.4s ease-in-out infinite both;
        }

        .loading-dots span:nth-child(1) { animation-delay: -0.32s; }
        .loading-dots span:nth-child(2) { animation-delay: -0.16s; }

        @keyframes bounce {
            0%, 80%, 100% { 
                transform: scale(0);
            } 40% { 
                transform: scale(1.0);
            }
        }

        /* ì ìˆ˜ ì¶”ì´ ê·¸ë˜í”„ */
        .score-chart {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
        }

        .chart-container {
            position: relative;
            height: 200px;
            margin: 15px 0;
        }

        .chart-svg {
            width: 100%;
            height: 100%;
        }

        /* ì ìˆ˜ ë³€í™”ëŸ‰ í‘œì‹œ */
        .score-change {
            font-size: 0.8rem;
            font-weight: bold;
            margin-left: 8px;
        }

        .score-change.positive {
            color: #27ae60;
        }

        .score-change.negative {
            color: #e74c3c;
        }

        .score-change.neutral {
            color: #95a5a6;
        }

        /* ì¶•í•˜ ì• ë‹ˆë©”ì´ì…˜ */
        .celebration {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
        }

        .firework {
            position: absolute;
            width: 4px;
            height: 4px;
            border-radius: 50%;
            animation: firework 2s ease-out forwards;
        }

        @keyframes firework {
            0% {
                transform: scale(1);
                opacity: 1;
            }
            100% {
                transform: scale(20);
                opacity: 0;
            }
        }

        .celebration-text {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 3rem;
            font-weight: bold;
            color: #ff6b35;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            animation: celebrationText 2s ease-out forwards;
            pointer-events: none;
            z-index: 10000;
        }

        @keyframes celebrationText {
            0% {
                transform: translate(-50%, -50%) scale(0);
                opacity: 0;
            }
            50% {
                transform: translate(-50%, -50%) scale(1.2);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 0;
            }
        }

        /* ë°˜ì‘í˜• */
        @media (max-width: 1200px) {
            .main-container {
                flex-direction: column;
                height: auto;
                gap: 15px;
            }
            
            .objective-container, .chat-container, .feedback-container {
                min-height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- ì¢Œì¸¡: í•™ìŠµ ëª©í‘œ ì˜ì—­ -->
        <div class="objective-container">
            <div class="objective-header">
                ğŸ“‹ í•™ìŠµ ëª©í‘œ
            </div>
            <div class="objective-content" id="objectiveContent">
                <div class="loading">
                    <span>í•™ìŠµ ëª©í‘œë¥¼ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤</span>
                    <div class="loading-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ì¤‘ì•™: í”„ë¡¬í”„íŠ¸ ì˜ì—­ -->
        <div class="chat-container">
            <div class="chat-header">
                <span>ğŸ’¬ í”„ë¡¬í”„íŠ¸ ì‘ì„±</span>
                <button class="settings-btn" onclick="goToSettings()">âš™ï¸ ì„¤ì •</button>
            </div>
            <div class="chat-content" id="chatContent">
                <!-- ë¹ˆ ìƒíƒœ í‘œì‹œ -->
                <div class="empty-state" id="emptyState">
                    <p>ğŸ’¡ ì¢Œì¸¡ì˜ í•™ìŠµ ëª©í‘œë¥¼ ì°¸ê³ í•˜ì—¬ AIì—ê²Œ ì§ˆë¬¸í•´ë³´ì„¸ìš”.</p>
                    <p>íš¨ê³¼ì ì¸ í”„ë¡¬í”„íŠ¸ ì‘ì„±ì„ ìœ„í•´ <strong>FIRE ìš”ì†Œ</strong>ë¥¼ ê³ ë ¤í•´ë³´ì„¸ìš”:</p>
                    <p><strong>Focus</strong> (ë¬´ì—‡ì„) â€¢ <strong>Input</strong> (ì–´ë–¤ ì •ë³´ë¡œ) â€¢ <strong>Rules</strong> (ì–´ë–»ê²Œ) â€¢ <strong>Effect</strong> (ì–´ë–¤ ëª©ì ìœ¼ë¡œ)</p>
                </div>
                
                <!-- ëŒ€í™” íˆìŠ¤í† ë¦¬ê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
            </div>
            <div class="chat-input-area">
                <div class="input-group">
                    <textarea 
                        id="chatInput" 
                        class="chat-input" 
                        placeholder="í”„ë¡¬í”„íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”... (Shift+Enterë¡œ ì¤„ë°”ê¿ˆ)"
                        rows="2"
                    ></textarea>
                    <button id="sendBtn" class="send-btn" onclick="sendMessage()">ì „ì†¡</button>
                </div>
            </div>
        </div>

        <!-- ìš°ì¸¡: í”¼ë“œë°± ì˜ì—­ -->
        <div class="feedback-container">
            <div class="feedback-header">
                ğŸ”¥ FIRE í”¼ë“œë°±
            </div>
            <div class="feedback-content" id="feedbackContent">
                <div style="text-align: center; padding: 40px; color: #666;">
                    <p>í”„ë¡¬í”„íŠ¸ë¥¼ ì…ë ¥í•˜ì‹œë©´<br>FIRE í‰ê°€ ê²°ê³¼ê°€<br>ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let settings = {};
        let chatHistory = [];
        let learningObjective = '';
        let scoreHistory = []; // ì ìˆ˜ ì¶”ì´ ì €ì¥

        // ë§ˆí¬ë‹¤ìš´ ë Œë”ë§ í•¨ìˆ˜
        function renderMarkdown(text) {
            if (typeof marked !== 'undefined') {
                return marked.parse(text);
            }
            // ë§ˆí¬ë‹¤ìš´ ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ í…ìŠ¤íŠ¸
            return text.replace(/\n/g, '<br>');
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            loadSettings();
            generateLearningObjective();
            setupEventListeners();
        });

        function loadSettings() {
            const savedSettings = localStorage.getItem('learningSettings');
            if (!savedSettings) {
                alert('ì„¤ì •ì´ ì—†ìŠµë‹ˆë‹¤. ì„¤ì • í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.');
                window.location.href = 'setup.html';
                return;
            }
            settings = JSON.parse(savedSettings);
        }

        function generateLearningObjective() {
            const topicTemplates = {
                'í™˜ê²½ ë¬¸ì œ': {
                    title: 'ğŸŒ í™˜ê²½ ë¬¸ì œ ë³´ê³ ì„œ ì‘ì„±',
                    mission: 'í™˜ê²½ ë¬¸ì œì— ëŒ€í•œ **2í˜ì´ì§€ ë³´ê³ ì„œ**ë¥¼ ì‘ì„±í•˜ì„¸ìš”.',
                    options: 'ì§€êµ¬ì˜¨ë‚œí™”, í•´ì–‘ì˜¤ì—¼, ì‚¼ë¦¼íŒŒê´´, ëŒ€ê¸°ì˜¤ì—¼ ì¤‘ ì„ íƒ'
                },
                'ê³¼í•™ ê¸°ìˆ ': {
                    title: 'ğŸ”¬ ê³¼í•™ ê¸°ìˆ  ì¡°ì‚¬ ë³´ê³ ì„œ',
                    mission: 'ìµœì‹  ê³¼í•™ ê¸°ìˆ ì— ëŒ€í•œ **ì¡°ì‚¬ ë°œí‘œìë£Œ**ë¥¼ ì‘ì„±í•˜ì„¸ìš”.',
                    options: 'AI, ìƒëª…ê³µí•™, ìš°ì£¼ê¸°ìˆ , ì‹ ì¬ìƒì—ë„ˆì§€ ì¤‘ ì„ íƒ'
                },
                'ì—­ì‚¬ì™€ ë¬¸í™”': {
                    title: 'ğŸ“œ ì—­ì‚¬ì™€ ë¬¸í™” íƒêµ¬',
                    mission: 'ì—­ì‚¬ì  ì‚¬ê±´ì´ë‚˜ ë¬¸í™” í˜„ìƒì— ëŒ€í•œ **íƒêµ¬ ë³´ê³ ì„œ**ë¥¼ ì‘ì„±í•˜ì„¸ìš”.',
                    options: 'ê·¼í˜„ëŒ€ì‚¬, ì„¸ê³„ì‚¬, ì „í†µë¬¸í™”, ë¬¸í™”ìœ ì‚° ì¤‘ ì„ íƒ'
                },
                'ì‚¬íšŒ ì´ìŠˆ': {
                    title: 'ğŸ›ï¸ ì‚¬íšŒ ë¬¸ì œ ë¶„ì„',
                    mission: 'í˜„ì¬ ì‚¬íšŒ ì´ìŠˆì— ëŒ€í•œ **ë¶„ì„ ë¦¬í¬íŠ¸**ë¥¼ ì‘ì„±í•˜ì„¸ìš”.',
                    options: 'ê³ ë ¹í™”, ì²­ë…„ë¬¸ì œ, ë„ì‹œí™”, ì‚¬íšŒë³µì§€ ì¤‘ ì„ íƒ'
                },
                'ë¬¸í•™ê³¼ ì˜ˆìˆ ': {
                    title: 'ğŸ¨ ë¬¸í•™Â·ì˜ˆìˆ  ê°ìƒ',
                    mission: 'ë¬¸í•™ ì‘í’ˆì´ë‚˜ ì˜ˆìˆ  ì‘í’ˆì— ëŒ€í•œ **ê°ìƒ ì—ì„¸ì´**ë¥¼ ì‘ì„±í•˜ì„¸ìš”.',
                    options: 'ê³ ì „ë¬¸í•™, í˜„ëŒ€ë¬¸í•™, ë¯¸ìˆ , ìŒì•… ì¤‘ ì„ íƒ'
                },
                'ê²½ì œì™€ ê²½ì˜': {
                    title: 'ğŸ’¼ ê²½ì œÂ·ê²½ì˜ ì‚¬ë¡€ ì—°êµ¬',
                    mission: 'ê²½ì œë‚˜ ê²½ì˜ ê´€ë ¨ **ì‚¬ë¡€ ë¶„ì„ ë³´ê³ ì„œ**ë¥¼ ì‘ì„±í•˜ì„¸ìš”.',
                    options: 'ì‹œì¥ê²½ì œ, ê¸°ì—…ì „ëµ, ì°½ì—…, ê¸ˆìœµ ì¤‘ ì„ íƒ'
                }
            };

            const template = topicTemplates[settings.topic] || topicTemplates['í™˜ê²½ ë¬¸ì œ'];
            learningObjective = template.mission;

            const objectiveMarkdown = `
# ${template.title}

## ğŸ¯ ë¯¸ì…˜
${template.mission}

## ğŸ“Œ ì£¼ì œ  
${template.options}

## ğŸ”¥ FIRE í”„ë¡¬í”„íŠ¸ ì‘ì„±ë²•
**íš¨ê³¼ì ì¸ í”„ë¡¬í”„íŠ¸ë¥¼ ìœ„í•œ 4ê°€ì§€ í•µì‹¬ ìš”ì†Œ:**

- **F: Focus** - ë¬´ì—‡ì„ ì•Œê³  ì‹¶ì€ê°€? (ëª…í™•í•œ ëª©ì )
- **I: Input** - ì–´ë–¤ ì •ë³´ë¥¼ ì£¼ì—ˆëŠ”ê°€? (ë°°ê²½, ë§¥ë½, ìë£Œ)  
- **R: Rules** - ì–´ë–»ê²Œ í‘œí˜„ë˜ê¸¸ ì›í•˜ëŠ”ê°€? (í˜•ì‹, ì¡°ê±´)
- **E: Effect** - ê²°ê³¼ê°€ ì–´ë–»ê²Œ ì“°ì¼ ê²ƒì¸ê°€? (ì‚¬ìš© ëª©ì )

> ğŸ’¡ **íŒ:** ê° ìš”ì†Œë¥¼ ê³ ë ¤í•˜ì—¬ AIê°€ ë” ì •í™•í•˜ê³  ìœ ìš©í•œ ë‹µë³€ì„ í•  ìˆ˜ ìˆë„ë¡ ë„ì™€ì£¼ì„¸ìš”!
            `;

            const objectiveHtml = `
                <div style="background: white; padding: 20px; border-radius: 12px;">
                    ${renderMarkdown(objectiveMarkdown)}
                </div>
            `;

            document.getElementById('objectiveContent').innerHTML = objectiveHtml;
        }

        function setupEventListeners() {
            const chatInput = document.getElementById('chatInput');
            
            // Enterë¡œ ì „ì†¡ (Shift+EnterëŠ” ì¤„ë°”ê¿ˆ)
            chatInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // ìë™ í¬ê¸° ì¡°ì ˆ
            chatInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
            });
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const sendBtn = document.getElementById('sendBtn');
            const prompt = input.value.trim();

            if (!prompt) {
                alert('í”„ë¡¬í”„íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            // ë¹ˆ ìƒíƒœ ìˆ¨ê¸°ê¸°
            const emptyState = document.getElementById('emptyState');
            if (emptyState) {
                emptyState.style.display = 'none';
            }

            // UI ì—…ë°ì´íŠ¸
            input.value = '';
            input.style.height = 'auto';
            sendBtn.disabled = true;
            sendBtn.textContent = 'ì „ì†¡ ì¤‘...';

            // ìƒˆ ëŒ€í™” ìŒ ì¶”ê°€
            const conversationId = 'conv-' + Date.now();
            addConversationPair(conversationId, prompt);

            // AI ì‘ë‹µê³¼ RTCF í‰ê°€ë¥¼ ë…ë¦½ì ìœ¼ë¡œ ì²˜ë¦¬
            let aiResponse = null;
            let evaluation = null;
            let responsesCompleted = 0;

            // AI ì‘ë‹µ ì²˜ë¦¬
            getAIResponse(prompt)
                .then(response => {
                    aiResponse = response;
                    updateConversationResponse(conversationId, response);
                    responsesCompleted++;
                    checkAllCompleted();
                })
                .catch(error => {
                    console.error('AI Response Error:', error);
                    updateConversationResponse(conversationId, `AI ì‘ë‹µ ì˜¤ë¥˜: ${error.message}`, true);
                    responsesCompleted++;
                    checkAllCompleted();
                });

            // FIRE í‰ê°€ ì²˜ë¦¬ (í”¼ë“œë°± ì˜ì—­ì— ë¡œë”© í‘œì‹œ)
            displayFeedbackLoading();
            
            evaluatePrompt(prompt)
                .then(result => {
                    evaluation = result;
                    displayFeedback(result);
                    responsesCompleted++;
                    checkAllCompleted();
                })
                .catch(error => {
                    console.error('Evaluation Error:', error);
                    displayFeedback({
                        fire_scores: {
                            focus: { score: 0, feedback: "í‰ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤." },
                            input: { score: 0, feedback: "í‰ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤." },
                            rules: { score: 0, feedback: "í‰ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤." },
                            effect: { score: 0, feedback: "í‰ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤." }
                        },
                        improvements: [],
                        suggestions: ["í‰ê°€ë¥¼ ë‹¤ì‹œ ì‹œë„í•´ë³´ì„¸ìš”."],
                        motivational_comment: "ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì§€ë§Œ ê³„ì† ë„ì „í•´ë³´ì„¸ìš”!"
                    });
                    responsesCompleted++;
                    checkAllCompleted();
                });

            function checkAllCompleted() {
                if (responsesCompleted >= 2) {
                    // ëª¨ë“  ì‘ë‹µì´ ì™„ë£Œë˜ë©´ íˆìŠ¤í† ë¦¬ì— ì¶”ê°€
                    if (aiResponse && evaluation) {
                        chatHistory.push({
                            prompt: prompt,
                            response: aiResponse,
                            evaluation: evaluation,
                            timestamp: new Date().toISOString()
                        });
                    }
                    
                    // UI ë³µì›
                    sendBtn.disabled = false;
                    sendBtn.textContent = 'ì „ì†¡';
                }
            }
        }

        function addConversationPair(id, prompt) {
            const chatContent = document.getElementById('chatContent');
            const conversationDiv = document.createElement('div');
            conversationDiv.className = 'conversation-pair';
            conversationDiv.id = id;
            
            conversationDiv.innerHTML = `
                <div class="prompt-box">
                    <div class="box-title">ğŸ“ í”„ë¡¬í”„íŠ¸</div>
                    <div class="box-content">${renderMarkdown(prompt)}</div>
                </div>
                <div class="response-box">
                    <div class="box-title">ğŸ¤– AI ì‘ë‹µ</div>
                    <div class="box-content" id="${id}-response">
                        <div class="loading-response">
                            <span>AIê°€ ì‘ë‹µì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤</span>
                            <div class="loading-dots">
                                <span></span>
                                <span></span>
                                <span></span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            chatContent.appendChild(conversationDiv);
            
            // ìŠ¤í¬ë¡¤ì„ ìƒˆ ëŒ€í™”ë¡œ ì´ë™
            conversationDiv.scrollIntoView({ behavior: 'smooth', block: 'end' });
        }

        function updateConversationResponse(id, response, isError = false) {
            const responseElement = document.getElementById(id + '-response');
            if (responseElement) {
                responseElement.innerHTML = isError ? 
                    `<div style="color: #dc3545;">${renderMarkdown(response)}</div>` : 
                    renderMarkdown(response);
            }
        }

        async function getAIResponse(prompt) {
            try {
                const response = await fetch('/api/oneshot', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        prompt: prompt,
                        temperature: 0.7,
                        maxTokens: 1000
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.detail || `HTTP ${response.status}: AI ì‘ë‹µ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.`);
                }

                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.error || 'AI ì‘ë‹µ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
                
                return data.response;
            } catch (error) {
                console.error('AI Response Error:', error);
                throw error;
            }
        }

        async function evaluatePrompt(prompt) {
            try {
                const previousPrompt = chatHistory.length > 0 ? 
                    chatHistory[chatHistory.length - 1].prompt : null;

                const response = await fetch('/api/evaluate-prompt', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        currentPrompt: prompt,
                        learningObjective: learningObjective,
                        previousPrompt: previousPrompt,
                        settings: settings
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.detail || `HTTP ${response.status}: í”„ë¡¬í”„íŠ¸ í‰ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.`);
                }

                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.error || 'í”„ë¡¬í”„íŠ¸ í‰ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
                
                return data.evaluation;
            } catch (error) {
                console.error('Evaluation Error:', error);
                throw error;
            }
        }


        function displayFeedbackLoading() {
            const feedbackHtml = `
                <div style="text-align: center; padding: 40px; color: #666;">
                    <div class="loading-response">
                        <span>FIRE í‰ê°€ë¥¼ ì§„í–‰í•˜ê³  ìˆìŠµë‹ˆë‹¤</span>
                        <div class="loading-dots">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('feedbackContent').innerHTML = feedbackHtml;
        }

        // ì ìˆ˜ ì¶”ì´ ê·¸ë˜í”„ ìƒì„±
        function createScoreChart() {
            if (scoreHistory.length < 2) return '';
            
            const maxScore = 12;
            const width = 300;
            const height = 150;
            const padding = 30;
            
            const chartWidth = width - 2 * padding;
            const chartHeight = height - 2 * padding;
            
            // ì ë“¤ ê³„ì‚°
            const points = scoreHistory.map((score, index) => {
                const x = padding + (chartWidth * index) / (scoreHistory.length - 1);
                const y = height - padding - (chartHeight * score) / maxScore;
                return `${x},${y}`;
            }).join(' ');
            
            // Yì¶• ëˆˆê¸ˆ
            const yTicks = [0, 3, 6, 9, 12].map(value => {
                const y = height - padding - (chartHeight * value) / maxScore;
                return `<line x1="${padding-5}" y1="${y}" x2="${padding}" y2="${y}" stroke="#ccc" stroke-width="1"/>
                        <text x="${padding-10}" y="${y+3}" text-anchor="end" font-size="10" fill="#666">${value}</text>`;
            }).join('');
            
            return `
                <div class="score-chart">
                    <h3>ğŸ“ˆ ì´ì  ì¶”ì´</h3>
                    <div class="chart-container">
                        <svg class="chart-svg" viewBox="0 0 ${width} ${height}">
                            <!-- ë°°ê²½ ê²©ì -->
                            ${[0, 3, 6, 9, 12].map(value => {
                                const y = height - padding - (chartHeight * value) / maxScore;
                                return `<line x1="${padding}" y1="${y}" x2="${width-padding}" y2="${y}" stroke="#f0f0f0" stroke-width="1"/>`;
                            }).join('')}
                            
                            <!-- Yì¶• ëˆˆê¸ˆ -->
                            ${yTicks}
                            
                            <!-- ì¶• -->
                            <line x1="${padding}" y1="${padding}" x2="${padding}" y2="${height-padding}" stroke="#333" stroke-width="2"/>
                            <line x1="${padding}" y1="${height-padding}" x2="${width-padding}" y2="${height-padding}" stroke="#333" stroke-width="2"/>
                            
                            <!-- ì„  ê·¸ë˜í”„ -->
                            <polyline points="${points}" fill="none" stroke="#ff6b35" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
                            
                            <!-- ì ë“¤ -->
                            ${scoreHistory.map((score, index) => {
                                const x = padding + (chartWidth * index) / (scoreHistory.length - 1);
                                const y = height - padding - (chartHeight * score) / maxScore;
                                return `<circle cx="${x}" cy="${y}" r="4" fill="#ff6b35" stroke="white" stroke-width="2"/>`;
                            }).join('')}
                        </svg>
                    </div>
                </div>
            `;
        }
        
        // ì¶•í•˜ ì• ë‹ˆë©”ì´ì…˜ ì‹¤í–‰
        function showCelebration() {
            const celebration = document.createElement('div');
            celebration.className = 'celebration';
            
            // í­ì£½ íš¨ê³¼
            for (let i = 0; i < 15; i++) {
                const firework = document.createElement('div');
                firework.className = 'firework';
                firework.style.left = Math.random() * 100 + '%';
                firework.style.top = Math.random() * 100 + '%';
                firework.style.backgroundColor = ['#ff6b35', '#f7931e', '#27ae60', '#e74c3c', '#3498db'][Math.floor(Math.random() * 5)];
                firework.style.animationDelay = Math.random() * 1 + 's';
                celebration.appendChild(firework);
            }
            
            // ì¶•í•˜ í…ìŠ¤íŠ¸
            const text = document.createElement('div');
            text.className = 'celebration-text';
            text.textContent = 'ğŸ‰ í›Œë¥­í•´ìš”! ğŸ‰';
            celebration.appendChild(text);
            
            document.body.appendChild(celebration);
            
            // 3ì´ˆ í›„ ì œê±°
            setTimeout(() => {
                document.body.removeChild(celebration);
            }, 3000);
        }

        function displayFeedback(evaluation) {
            const circles = (score) => 'â—'.repeat(score) + 'â—‹'.repeat(3 - score);
            
            // FIRE ì ìˆ˜ ì²˜ë¦¬ (ì´ì  ê³„ì‚°)
            const fireScores = evaluation.fire_scores || {};
            const totalScore = evaluation.total_score || Object.values(fireScores).reduce((sum, item) => sum + (item.score || 0), 0);
            const grade = evaluation.grade || (totalScore >= 10 ? 'ìš°ìˆ˜' : totalScore >= 7 ? 'ì–‘í˜¸' : totalScore >= 4 ? 'ê°œì„  í•„ìš”' : 'ë¶€ì ì ˆ');
            
            // ì´ì „ ì ìˆ˜ì™€ ë¹„êµ
            const previousScore = scoreHistory.length > 0 ? scoreHistory[scoreHistory.length - 1] : null;
            const previousEvaluation = chatHistory.length > 0 ? chatHistory[chatHistory.length - 1].evaluation : null;
            
            // ì ìˆ˜ ë³€í™”ëŸ‰ ê³„ì‚° í•¨ìˆ˜
            const getScoreChange = (current, previous, key) => {
                if (!previous || !previous.fire_scores || !previous.fire_scores[key]) return '';
                const diff = current - previous.fire_scores[key].score;
                if (diff > 0) return `<span class="score-change positive">+${diff}</span>`;
                if (diff < 0) return `<span class="score-change negative">${diff}</span>`;
                return `<span class="score-change neutral">Â±0</span>`;
            };
            
            // ì´ì ì´ í–¥ìƒë˜ì—ˆëŠ”ì§€ í™•ì¸
            const scoreImproved = previousScore !== null && totalScore > previousScore;
            
            // ì ìˆ˜ íˆìŠ¤í† ë¦¬ ì—…ë°ì´íŠ¸
            scoreHistory.push(totalScore);
            
            // ì¶•í•˜ ì• ë‹ˆë©”ì´ì…˜ ì‹¤í–‰
            if (scoreImproved) {
                setTimeout(() => showCelebration(), 500);
            }
            
            // ì°¨íŠ¸ HTML ìƒì„±
            const chartHtml = createScoreChart();
            
            const feedbackHtml = `
                ${chartHtml}
                
                <div class="fire-scores">
                    <h3>ğŸ”¥ FIRE ì ìˆ˜</h3>
                    <div class="score-item">
                        <span class="score-name">Focus (ë¬´ì—‡ì„)</span>
                        <div class="score-value">
                            <span class="stars">${circles(fireScores.focus?.score || 0)}</span>
                            <span>${fireScores.focus?.score || 0}/3</span>
                            ${getScoreChange(fireScores.focus?.score || 0, previousEvaluation, 'focus')}
                        </div>
                    </div>
                    <div class="score-item">
                        <span class="score-name">Input (ì–´ë–¤ ì •ë³´ë¡œ)</span>
                        <div class="score-value">
                            <span class="stars">${circles(fireScores.input?.score || 0)}</span>
                            <span>${fireScores.input?.score || 0}/3</span>
                            ${getScoreChange(fireScores.input?.score || 0, previousEvaluation, 'input')}
                        </div>
                    </div>
                    <div class="score-item">
                        <span class="score-name">Rules (ì–´ë–»ê²Œ)</span>
                        <div class="score-value">
                            <span class="stars">${circles(fireScores.rules?.score || 0)}</span>
                            <span>${fireScores.rules?.score || 0}/3</span>
                            ${getScoreChange(fireScores.rules?.score || 0, previousEvaluation, 'rules')}
                        </div>
                    </div>
                    <div class="score-item">
                        <span class="score-name">Effect (ì–´ë–¤ ëª©ì ìœ¼ë¡œ)</span>
                        <div class="score-value">
                            <span class="stars">${circles(fireScores.effect?.score || 0)}</span>
                            <span>${fireScores.effect?.score || 0}/3</span>
                            ${getScoreChange(fireScores.effect?.score || 0, previousEvaluation, 'effect')}
                        </div>
                    </div>
                    <div class="score-item" style="border-top: 2px solid #ddd; margin-top: 10px; padding-top: 10px; font-weight: bold;">
                        <span class="score-name">ì´ì </span>
                        <div class="score-value">
                            <span style="color: ${totalScore >= 10 ? '#28a745' : totalScore >= 7 ? '#ffc107' : totalScore >= 4 ? '#fd7e14' : '#dc3545'}; font-weight: bold;">${grade}</span>
                            <span>${totalScore}/12</span>
                            ${previousScore !== null ? (totalScore > previousScore ? `<span class="score-change positive">+${totalScore - previousScore}</span>` : totalScore < previousScore ? `<span class="score-change negative">${totalScore - previousScore}</span>` : `<span class="score-change neutral">Â±0</span>`) : ''}
                        </div>
                    </div>
                </div>

                ${evaluation.improvements && evaluation.improvements.length > 0 ? `
                <div class="feedback-section">
                    <h4>âœ… ê°œì„ ëœ ì </h4>
                    ${evaluation.improvements.map(imp => `<p>â€¢ ${imp}</p>`).join('')}
                </div>
                ` : ''}

                <div class="feedback-section">
                    <h4>ğŸ’¡ ê°œì„  ì œì•ˆ</h4>
                    ${evaluation.suggestions.map(sug => `<p>â€¢ ${sug}</p>`).join('')}
                </div>

                <div class="feedback-section" style="border-left-color: #28a745;">
                    <h4>ğŸ‰ ê²©ë ¤ ë©”ì‹œì§€</h4>
                    <p>${evaluation.motivational_comment}</p>
                </div>
            `;

            document.getElementById('feedbackContent').innerHTML = feedbackHtml;
        }


        function goToSettings() {
            if (confirm('ì„¤ì •ì„ ë³€ê²½í•˜ë©´ í˜„ì¬ ì§„í–‰ ì¤‘ì¸ í•™ìŠµì´ ì´ˆê¸°í™”ë©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                window.location.href = 'setup.html';
            }
        }
    </script>
</body>
</html>