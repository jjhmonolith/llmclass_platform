#!/bin/bash

# ğŸ“ LLM Classroom í†µí•© ê´€ë¦¬ ë„êµ¬
# ë²„ì „: 1.0.0
# ìƒì„±ì¼: 2025-08-25

set -e

# ìƒ‰ìƒ ì •ì˜
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# í”„ë¡œì íŠ¸ ê²½ë¡œ
PROJECT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
PIDS_DIR="$PROJECT_DIR/.pids"
LOGS_DIR="$PROJECT_DIR/logs"
CONFIG_FILE="$PROJECT_DIR/config/services.yml"

# PID ë””ë ‰í† ë¦¬ ìƒì„±
mkdir -p "$PIDS_DIR" "$LOGS_DIR"

# ë„ì›€ë§ í‘œì‹œ
show_help() {
    echo -e "${BLUE}ğŸ“ LLM Classroom í†µí•© ê´€ë¦¬ ë„êµ¬${NC}"
    echo ""
    echo "ì‚¬ìš©ë²•: ./llmclass [ëª…ë ¹] [ì˜µì…˜]"
    echo ""
    echo "ëª…ë ¹ì–´:"
    echo "  start      ëª¨ë“  ì„œë¹„ìŠ¤ì™€ í„°ë„ ì‹œì‘"
    echo "  stop       ëª¨ë“  ì„œë¹„ìŠ¤ì™€ í„°ë„ ì¢…ë£Œ"
    echo "  restart    ëª¨ë“  ì„œë¹„ìŠ¤ ì¬ì‹œì‘"
    echo "  status     ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸"
    echo "  logs       ë¡œê·¸ í™•ì¸ (ì‹¤ì‹œê°„)"
    echo "  tunnel     í„°ë„ë§Œ ê´€ë¦¬"
    echo "  health     í—¬ìŠ¤ì²´í¬"
    echo "  doctor     ë¬¸ì œ ì§„ë‹¨ ë° ìë™ ìˆ˜ì •"
    echo ""
    echo "ì˜µì…˜:"
    echo "  --local    ë¡œì»¬ ì „ìš© ëª¨ë“œ (í„°ë„ ì—†ì´)"
    echo "  --debug    ë””ë²„ê·¸ ëª¨ë“œ"
    echo ""
    echo "ì˜ˆì‹œ:"
    echo "  ./llmclass start        # ëª¨ë“  ì„œë¹„ìŠ¤ ì‹œì‘"
    echo "  ./llmclass status       # ìƒíƒœ í™•ì¸"
    echo "  ./llmclass logs proto4  # proto4 ë¡œê·¸ ë³´ê¸°"
}

# ì„œë¹„ìŠ¤ ì‹œì‘
start_services() {
    echo -e "${BLUE}ğŸš€ LLM Classroom ì„œë¹„ìŠ¤ ì‹œì‘ ì¤‘...${NC}"
    
    # ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ í™•ì¸
    if check_services; then
        echo -e "${YELLOW}âš ï¸  ì¼ë¶€ ì„œë¹„ìŠ¤ê°€ ì´ë¯¸ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤.${NC}"
        echo "   ì¬ì‹œì‘í•˜ë ¤ë©´ 'restart' ëª…ë ¹ì„ ì‚¬ìš©í•˜ì„¸ìš”."
        return 1
    fi
    
    # ê° ì„œë¹„ìŠ¤ ì‹œì‘
    echo -e "${GREEN}ğŸ“š Proto4 (Socratic) ì‹œì‘...${NC}"
    cd "$PROJECT_DIR/proto4/backend"
    nohup python3 main.py > "$LOGS_DIR/proto4.log" 2>&1 &
    echo $! > "$PIDS_DIR/proto4.pid"
    sleep 2
    
    echo -e "${GREEN}ğŸ¯ Proto1 (Strategic) ì‹œì‘...${NC}"
    cd "$PROJECT_DIR/proto1"
    nohup python3 main.py > "$LOGS_DIR/proto1.log" 2>&1 &
    echo $! > "$PIDS_DIR/proto1.pid"
    sleep 2
    
    echo -e "${GREEN}ğŸ”¥ Proto3 (FIRE) ì‹œì‘...${NC}"
    cd "$PROJECT_DIR/proto3"
    nohup python3 main.py > "$LOGS_DIR/proto3.log" 2>&1 &
    echo $! > "$PIDS_DIR/proto3.pid"
    sleep 2
    
    echo -e "${GREEN}ğŸ  Student Hub ì‹œì‘...${NC}"
    cd "$PROJECT_DIR/student/backend"
    nohup python3 main.py > "$LOGS_DIR/hub.log" 2>&1 &
    echo $! > "$PIDS_DIR/hub.pid"
    sleep 2
    
    # ë¡œì»¬ ëª¨ë“œê°€ ì•„ë‹ˆë©´ í„°ë„ ì‹œì‘
    if [[ "$1" != "--local" ]]; then
        start_tunnel
    fi
    
    echo -e "${GREEN}âœ… ëª¨ë“  ì„œë¹„ìŠ¤ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!${NC}"
    show_status
}

# ì„œë¹„ìŠ¤ ì¤‘ì§€
stop_services() {
    echo -e "${RED}ğŸ›‘ ì„œë¹„ìŠ¤ ì¢…ë£Œ ì¤‘...${NC}"
    
    # PID íŒŒì¼ë¡œ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ
    for service in proto4 proto1 proto3 hub; do
        if [ -f "$PIDS_DIR/$service.pid" ]; then
            PID=$(cat "$PIDS_DIR/$service.pid")
            if kill -0 $PID 2>/dev/null; then
                kill $PID
                echo "   $service ì¢…ë£Œë¨ (PID: $PID)"
            fi
            rm -f "$PIDS_DIR/$service.pid"
        fi
    done
    
    # í„°ë„ ì¢…ë£Œ
    stop_tunnel
    
    echo -e "${GREEN}âœ… ëª¨ë“  ì„œë¹„ìŠ¤ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.${NC}"
}

# í„°ë„ ì‹œì‘
start_tunnel() {
    echo -e "${BLUE}ğŸŒ CloudFlare í„°ë„ ì‹œì‘ ì¤‘...${NC}"
    
    # ê¸°ì¡´ í„°ë„ í”„ë¡œì„¸ìŠ¤ í™•ì¸ ë° ì¢…ë£Œ
    pkill -f "cloudflared.*config-llmclass" 2>/dev/null || true
    sleep 2
    
    # í„°ë„ ì‹œì‘
    nohup cloudflared tunnel --config "$HOME/.cloudflared/config-llmclass.yml" run > "$LOGS_DIR/tunnel.log" 2>&1 &
    echo $! > "$PIDS_DIR/tunnel.pid"
    
    sleep 3
    echo -e "${GREEN}âœ… í„°ë„ì´ ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤.${NC}"
}

# í„°ë„ ì¤‘ì§€
stop_tunnel() {
    echo -e "${RED}ğŸŒ í„°ë„ ì¢…ë£Œ ì¤‘...${NC}"
    
    # PID íŒŒì¼ë¡œ ì¢…ë£Œ
    if [ -f "$PIDS_DIR/tunnel.pid" ]; then
        PID=$(cat "$PIDS_DIR/tunnel.pid")
        if kill -0 $PID 2>/dev/null; then
            kill $PID
            echo "   í„°ë„ ì¢…ë£Œë¨ (PID: $PID)"
        fi
        rm -f "$PIDS_DIR/tunnel.pid"
    fi
    
    # í˜¹ì‹œ ë‚¨ì•„ìˆëŠ” í”„ë¡œì„¸ìŠ¤ ì •ë¦¬
    pkill -f "cloudflared.*config-llmclass" 2>/dev/null || true
}

# ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
check_services() {
    local running=0
    
    for service in proto4 proto1 proto3 hub; do
        if [ -f "$PIDS_DIR/$service.pid" ]; then
            PID=$(cat "$PIDS_DIR/$service.pid")
            if kill -0 $PID 2>/dev/null; then
                running=$((running + 1))
            else
                rm -f "$PIDS_DIR/$service.pid"
            fi
        fi
    done
    
    [ $running -gt 0 ]
}

# ìƒíƒœ í‘œì‹œ
show_status() {
    echo -e "${BLUE}ğŸ“Š ì„œë¹„ìŠ¤ ìƒíƒœ${NC}"
    echo "================================="
    
    # ê° ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
    for service in proto4 proto1 proto3 hub; do
        if [ -f "$PIDS_DIR/$service.pid" ]; then
            PID=$(cat "$PIDS_DIR/$service.pid")
            if kill -0 $PID 2>/dev/null; then
                case $service in
                    proto4) 
                        echo -e "âœ… Proto4 (Socratic)  : ${GREEN}ì‹¤í–‰ì¤‘${NC} [PID: $PID] â†’ socratic.llmclass.org"
                        ;;
                    proto1)
                        echo -e "âœ… Proto1 (Strategic) : ${GREEN}ì‹¤í–‰ì¤‘${NC} [PID: $PID] â†’ strategic.llmclass.org"
                        ;;
                    proto3)
                        echo -e "âœ… Proto3 (FIRE)      : ${GREEN}ì‹¤í–‰ì¤‘${NC} [PID: $PID] â†’ fire.llmclass.org"
                        ;;
                    hub)
                        echo -e "âœ… Student Hub        : ${GREEN}ì‹¤í–‰ì¤‘${NC} [PID: $PID] â†’ hub.llmclass.org"
                        ;;
                esac
            else
                echo -e "âŒ $service: ${RED}ì¤‘ì§€ë¨${NC}"
                rm -f "$PIDS_DIR/$service.pid"
            fi
        else
            echo -e "âŒ $service: ${RED}ì¤‘ì§€ë¨${NC}"
        fi
    done
    
    # í„°ë„ ìƒíƒœ
    if [ -f "$PIDS_DIR/tunnel.pid" ]; then
        PID=$(cat "$PIDS_DIR/tunnel.pid")
        if kill -0 $PID 2>/dev/null; then
            echo -e "âœ… CloudFlare í„°ë„    : ${GREEN}ì—°ê²°ë¨${NC} [PID: $PID]"
        else
            echo -e "âŒ CloudFlare í„°ë„: ${RED}ì—°ê²° ì•ˆë¨${NC}"
        fi
    else
        echo -e "âŒ CloudFlare í„°ë„: ${RED}ì—°ê²° ì•ˆë¨${NC}"
    fi
    
    echo "================================="
    
    # í¬íŠ¸ ìƒíƒœ
    echo -e "\n${BLUE}ğŸ“¡ í¬íŠ¸ ìƒíƒœ${NC}"
    echo "--------------------------------"
    for port in 8000 8001 8002 8003; do
        if lsof -i :$port > /dev/null 2>&1; then
            echo -e "âœ… í¬íŠ¸ $port: ${GREEN}ì‚¬ìš©ì¤‘${NC}"
        else
            echo -e "âŒ í¬íŠ¸ $port: ${RED}ë¯¸ì‚¬ìš©${NC}"
        fi
    done
}

# í—¬ìŠ¤ì²´í¬
health_check() {
    echo -e "${BLUE}ğŸ¥ í—¬ìŠ¤ì²´í¬ ì‹¤í–‰ ì¤‘...${NC}"
    echo "================================="
    
    local all_healthy=true
    
    # ê° ì„œë¹„ìŠ¤ í—¬ìŠ¤ì²´í¬
    for port in 8000 8001 8002 8003; do
        response=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:$port/health 2>/dev/null)
        if [ "$response" = "200" ]; then
            echo -e "âœ… í¬íŠ¸ $port: ${GREEN}ì •ìƒ${NC}"
        else
            echo -e "âŒ í¬íŠ¸ $port: ${RED}ì‘ë‹µ ì—†ìŒ${NC}"
            all_healthy=false
        fi
    done
    
    # ì™¸ë¶€ ì ‘ì† í…ŒìŠ¤íŠ¸
    echo -e "\n${BLUE}ğŸŒ ì™¸ë¶€ ì ‘ì† í…ŒìŠ¤íŠ¸${NC}"
    echo "--------------------------------"
    for domain in hub fire strategic socratic; do
        response=$(curl -s -o /dev/null -w "%{http_code}" https://$domain.llmclass.org 2>/dev/null)
        if [ "$response" = "200" ] || [ "$response" = "405" ]; then
            echo -e "âœ… $domain.llmclass.org: ${GREEN}ì ‘ì† ê°€ëŠ¥${NC}"
        else
            echo -e "âŒ $domain.llmclass.org: ${RED}ì ‘ì† ë¶ˆê°€${NC} (HTTP $response)"
            all_healthy=false
        fi
    done
    
    if $all_healthy; then
        echo -e "\n${GREEN}âœ… ëª¨ë“  ì„œë¹„ìŠ¤ê°€ ì •ìƒì…ë‹ˆë‹¤!${NC}"
    else
        echo -e "\n${YELLOW}âš ï¸  ì¼ë¶€ ì„œë¹„ìŠ¤ì— ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤.${NC}"
        echo "   './llmclass doctor'ë¥¼ ì‹¤í–‰í•˜ì—¬ ìë™ ìˆ˜ì •ì„ ì‹œë„í•˜ì„¸ìš”."
    fi
}

# ë¬¸ì œ ì§„ë‹¨ ë° ìˆ˜ì •
doctor() {
    echo -e "${BLUE}ğŸ”§ ì‹œìŠ¤í…œ ì§„ë‹¨ ë° ìë™ ìˆ˜ì •...${NC}"
    
    # ì¤‘ë³µ í„°ë„ í™•ì¸
    echo "1. ì¤‘ë³µ í„°ë„ í”„ë¡œì„¸ìŠ¤ í™•ì¸..."
    local tunnel_count=$(pgrep -f "cloudflared.*config-llmclass" | wc -l)
    if [ $tunnel_count -gt 1 ]; then
        echo -e "${YELLOW}   âš ï¸  ì¤‘ë³µ í„°ë„ ë°œê²¬ ($tunnel_countê°œ)${NC}"
        echo "   ìˆ˜ì • ì¤‘..."
        pkill -f "cloudflared.*config-llmclass"
        sleep 2
        start_tunnel
        echo -e "${GREEN}   âœ… ìˆ˜ì • ì™„ë£Œ${NC}"
    else
        echo -e "${GREEN}   âœ… ì •ìƒ${NC}"
    fi
    
    # í¬íŠ¸ ì¶©ëŒ í™•ì¸
    echo "2. í¬íŠ¸ ì¶©ëŒ í™•ì¸..."
    local port_issue=false
    for port in 8000 8001 8002 8003; do
        if lsof -i :$port > /dev/null 2>&1; then
            # PID í™•ì¸
            local port_pid=$(lsof -ti :$port)
            local service_name=""
            case $port in
                8000) service_name="proto4" ;;
                8001) service_name="proto1" ;;
                8002) service_name="proto3" ;;
                8003) service_name="hub" ;;
            esac
            
            if [ -f "$PIDS_DIR/$service_name.pid" ]; then
                local expected_pid=$(cat "$PIDS_DIR/$service_name.pid")
                if [ "$port_pid" != "$expected_pid" ]; then
                    echo -e "${YELLOW}   âš ï¸  í¬íŠ¸ $port: PID ë¶ˆì¼ì¹˜${NC}"
                    port_issue=true
                fi
            fi
        fi
    done
    
    if $port_issue; then
        echo "   ì „ì²´ ì¬ì‹œì‘ì„ ê¶Œì¥í•©ë‹ˆë‹¤."
        echo "   './llmclass restart' ì‹¤í–‰"
    else
        echo -e "${GREEN}   âœ… ì •ìƒ${NC}"
    fi
    
    echo -e "\n${GREEN}âœ… ì§„ë‹¨ ì™„ë£Œ!${NC}"
}

# ë¡œê·¸ ë³´ê¸°
show_logs() {
    local service=$1
    if [ -z "$service" ]; then
        echo "ì „ì²´ ë¡œê·¸ ë³´ê¸° (Ctrl+Cë¡œ ì¢…ë£Œ)"
        tail -f "$LOGS_DIR"/*.log
    else
        if [ -f "$LOGS_DIR/$service.log" ]; then
            echo "$service ë¡œê·¸ ë³´ê¸° (Ctrl+Cë¡œ ì¢…ë£Œ)"
            tail -f "$LOGS_DIR/$service.log"
        else
            echo -e "${RED}ì˜¤ë¥˜: $service ë¡œê·¸ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.${NC}"
        fi
    fi
}

# ë©”ì¸ ì‹¤í–‰
case "$1" in
    start)
        start_services $2
        ;;
    stop)
        stop_services
        ;;
    restart)
        stop_services
        sleep 2
        start_services
        ;;
    status)
        show_status
        ;;
    health)
        health_check
        ;;
    doctor)
        doctor
        ;;
    tunnel)
        case "$2" in
            start) start_tunnel ;;
            stop) stop_tunnel ;;
            restart) stop_tunnel; sleep 2; start_tunnel ;;
            *) echo "ì‚¬ìš©ë²•: ./llmclass tunnel [start|stop|restart]" ;;
        esac
        ;;
    logs)
        show_logs $2
        ;;
    *)
        show_help
        ;;
esac