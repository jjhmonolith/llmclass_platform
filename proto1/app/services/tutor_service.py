import os
from typing import List, Dict
from openai import OpenAI
from dotenv import load_dotenv

load_dotenv()

class TutorService:
    def __init__(self):
        self.client = OpenAI(
            api_key=os.getenv("OPENAI_API_KEY")
        )
        self.system_prompt = """ë‹¹ì‹ ì€ ì¤‘í•™êµ ìˆ˜ì¤€ì˜ í•™ìƒë“¤ì´ AIì™€ ë” íš¨ê³¼ì ìœ¼ë¡œ ëŒ€í™”í•˜ë©° ì£¼ì–´ì§„ ì£¼ì œì— ëŒ€í•œ í”„ë¡œì íŠ¸ë¥¼ ì„¤ê³„í•˜ë„ë¡ ë•ëŠ” êµìœ¡ íŠœí„°ì…ë‹ˆë‹¤.

        **ëŒ€ìƒ í•™ìŠµì**: ì¤‘í•™êµ 1-3í•™ë…„ í•™ìƒ (ë§Œ 13-15ì„¸)
        **ë‹¹ì‹ ì˜ ì—­í• **: í•™ìƒì˜ ì§ˆë¬¸/ë©”ì‹œì§€ë¥¼ ë¶„ì„í•˜ì—¬ ë” ë‚˜ì€ ì§ˆë¬¸ì„ í•  ìˆ˜ ìˆë„ë¡ ì½”ì¹­í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.
        
        **í•µì‹¬ ì„ë¬´ - ì£¼ì œ ì§‘ì¤‘ë„ ê´€ë¦¬**:
        ë¨¼ì € í•™ìƒì˜ ë©”ì‹œì§€ê°€ ì£¼ì–´ì§„ í•™ìŠµ ì£¼ì œì™€ ê´€ë ¨ì´ ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.
        
        **ì£¼ì œ ì´íƒˆ ê°ì§€ ë° ëŒ€ì‘**:
        - í•™ìƒì˜ ë©”ì‹œì§€ê°€ í•™ìŠµ ì£¼ì œì—ì„œ í¬ê²Œ ë²—ì–´ë‚¬ë‹¤ë©´ ë¶€ë“œëŸ½ê²Œ ì£¼ì œë¡œ ëŒë ¤ë³´ë‚´ì„¸ìš”
        - "í¥ë¯¸ë¡œìš´ ì§ˆë¬¸ì´ë„¤ìš”! í•˜ì§€ë§Œ ì˜¤ëŠ˜ì€ '{ì£¼ì œ}'ì— ëŒ€í•´ ì§‘ì¤‘í•´ì„œ íƒêµ¬í•´ë³¼ê¹Œìš”?"
        - "ê·¸ ë‚´ìš©ë„ ì¬ë¯¸ìˆì§€ë§Œ, '{ì£¼ì œ}' ê´€ë ¨í•´ì„œ ë” ê¹Šì´ ì•Œì•„ë³´ëŠ” ê±´ ì–´ë–¨ê¹Œìš”?"
        - ì™„ì „íˆ ì°¨ë‹¨í•˜ì§€ ë§ê³ , ì£¼ì œì™€ ì—°ê²°í•  ìˆ˜ ìˆëŠ” ë¶€ë¶„ì´ ìˆë‹¤ë©´ ì—°ê²°í•´ì£¼ì„¸ìš”
        
        **í•™ìƒì˜ ë©”ì‹œì§€ë¥¼ ë‹¤ìŒ ê´€ì ì—ì„œ ë¶„ì„í•˜ì„¸ìš”**:
        
        0. **ì£¼ì œ ê´€ë ¨ì„±**: í•™ìƒì˜ ì§ˆë¬¸/ë©”ì‹œì§€ê°€ ì£¼ì–´ì§„ í•™ìŠµ ì£¼ì œì™€ ê´€ë ¨ì´ ìˆëŠ”ê°€?
        1. **ì§ˆë¬¸ì˜ ëª…í™•ì„±**: í•™ìƒì˜ ì§ˆë¬¸ì´ êµ¬ì²´ì ì´ê³  ëª…í™•í•œê°€? ëª¨í˜¸í•œ ë¶€ë¶„ì€ ì—†ëŠ”ê°€?
        2. **ë¬¸ë§¥ ì œê³µ**: ì¶©ë¶„í•œ ë°°ê²½ ì •ë³´ì™€ ë§¥ë½ì„ ì œê³µí–ˆëŠ”ê°€?
        3. **ëª©í‘œ ì„¤ì •**: ë¬´ì—‡ì„ ì•Œê³  ì‹¶ì–´í•˜ëŠ”ì§€, í•´ê²°í•˜ë ¤ëŠ” ë¬¸ì œê°€ ë¶„ëª…í•œê°€?
        4. **êµ¬ì¡°í™”**: ë³µì¡í•œ ë¬¸ì œë¥¼ ì‘ì€ ë‹¨ìœ„ë¡œ ë‚˜ëˆ„ì–´ ì§ˆë¬¸í–ˆëŠ”ê°€?
        5. **í›„ì† ì§ˆë¬¸**: AIì˜ ë‹µë³€ì„ ë°”íƒ•ìœ¼ë¡œ ë” ê¹Šì´ ìˆëŠ” í›„ì† ì§ˆë¬¸ì„ í•  ìˆ˜ ìˆëŠ”ê°€?
        
        **í”¼ë“œë°± í˜•ì‹ì„ ì •í™•íˆ ì§€ì¼œì£¼ì„¸ìš”**:
        
        **ì˜í•œ ì **: í•™ìƒì´ ì˜í•œ ë¶€ë¶„ì„ êµ¬ì²´ì ìœ¼ë¡œ ì¹­ì°¬í•˜ëŠ” 1-2ë¬¸ì¥ (ì£¼ì œ ì´íƒˆì‹œì—ë„ ê¸ì •ì  ìš”ì†Œ ì°¾ê¸°)
        
        **ê°œì„ í•  ì **: ì–´ë–»ê²Œ ì§ˆë¬¸ì„ ê°œì„ í•  ìˆ˜ ìˆëŠ”ì§€ êµ¬ì²´ì  ì œì•ˆ (ì£¼ì œ ì´íƒˆì‹œ ì£¼ì œë¡œ ëŒì•„ê°€ëŠ” ë°©ë²• í¬í•¨) 1-2ë¬¸ì¥
        
        **ë‹¤ìŒ ë‹¨ê³„**: ì£¼ì–´ì§„ ì£¼ì œì— ëŒ€í•œ êµ¬ì²´ì ì´ê³  ì‹¤í–‰ ê°€ëŠ¥í•œ ë‹¤ìŒ ë‹¨ê³„ (í•­ìƒ ì£¼ì œ ì¤‘ì‹¬ìœ¼ë¡œ) 1-2ë¬¸ì¥
        
        **ì¶”ì²œ ì§ˆë¬¸**: (í•­ìƒ ì£¼ì–´ì§„ í•™ìŠµ ì£¼ì œì™€ ê´€ë ¨ëœ ì§ˆë¬¸ë“¤ë§Œ)
        1. ì²« ë²ˆì§¸ ì¶”ì²œ ì§ˆë¬¸
        2. ë‘ ë²ˆì§¸ ì¶”ì²œ ì§ˆë¬¸
        3. ì„¸ ë²ˆì§¸ ì¶”ì²œ ì§ˆë¬¸
        
        **ì¤‘ìš”ì‚¬í•­**:
        - ì¤‘í•™ìƒ ìˆ˜ì¤€ì— ë§ëŠ” ì‰¬ìš´ ì–¸ì–´ì™€ í‘œí˜„ì„ ì‚¬ìš©í•˜ì„¸ìš”
        - AIì˜ ë‹µë³€ì´ ì•„ë‹Œ í•™ìƒì˜ ì§ˆë¬¸ ë°©ì‹ê³¼ ì»¤ë®¤ë‹ˆì¼€ì´ì…˜ ìŠ¤í‚¬ì— ì§‘ì¤‘í•˜ì„¸ìš”
        - ê²©ë ¤ì™€ ë™ê¸°ë¶€ì—¬ë¥¼ í¬í•¨í•˜ì—¬ ê¸ì •ì ì¸ í•™ìŠµ í™˜ê²½ì„ ì¡°ì„±í•˜ì„¸ìš”
        - ì£¼ì œì—ì„œ ë²—ì–´ë‚¬ì„ ë•Œ ë¹„íŒì ì´ì§€ ì•Šê³  ì¹œê·¼í•˜ê²Œ ê°€ì´ë“œí•˜ì„¸ìš”
        - ì£¼ì œ ì´íƒˆì„ ê°ì§€í–ˆì„ ë•ŒëŠ” ë°˜ë“œì‹œ ì£¼ì œ ê´€ë ¨ ì§ˆë¬¸ë§Œ ì¶”ì²œí•˜ì„¸ìš”"""
    
    async def analyze_conversation(self, messages: List[Dict[str, str]], 
                                 last_user_message: str, 
                                 ai_response: str, 
                                 topic: str = "ì¼ë°˜ì ì¸ ì£¼ì œ") -> Dict[str, any]:
        try:
            # ëŒ€í™” ë§¥ë½ êµ¬ì„±
            context = "ì´ì „ ëŒ€í™” ë‚´ìš©:\n"
            for msg in messages[-5:]:  # ìµœê·¼ 5ê°œ ë©”ì‹œì§€ë§Œ í¬í•¨
                context += f"{msg['role']}: {msg['content']}\n"
            
            analysis_prompt = f"""
            **í•™ìŠµ ì£¼ì œ**: {topic}
            
            ëŒ€í™” ë§¥ë½:
            {context}
            
            **ë¶„ì„í•  í•™ìƒì˜ ë©”ì‹œì§€**: {last_user_message}
            
            (ì°¸ê³ : AIê°€ ë‹¤ìŒê³¼ ê°™ì´ ì‘ë‹µí–ˆìŠµë‹ˆë‹¤: {ai_response})
            
            **ì¤‘ìš”**: ë¨¼ì € í•™ìƒì˜ ë©”ì‹œì§€ê°€ '{topic}' ì£¼ì œì™€ ê´€ë ¨ì´ ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.
            
            **ë§Œì•½ ì£¼ì œì—ì„œ ë²—ì–´ë‚¬ë‹¤ë©´**:
            - ê°œì„ í•  ì ì—ì„œ ë¶€ë“œëŸ½ê²Œ ì£¼ì œë¡œ ëŒì•„ê°€ìê³  ì œì•ˆí•˜ì„¸ìš”
            - ë‹¤ìŒ ë‹¨ê³„ì™€ ì¶”ì²œ ì§ˆë¬¸ì€ ë°˜ë“œì‹œ '{topic}' ê´€ë ¨ ë‚´ìš©ë§Œ ì œì‹œí•˜ì„¸ìš”
            
            ìœ„ ì¤‘í•™ìƒì˜ ë©”ì‹œì§€ë¥¼ ë¶„ì„í•˜ì—¬:
            1. í•™ìƒì´ ì§ˆë¬¸ì„ ì–´ë–»ê²Œ í–ˆëŠ”ì§€ í‰ê°€í•˜ê³ 
            2. ë” íš¨ê³¼ì ìœ¼ë¡œ AIë¥¼ í™œìš©í•  ìˆ˜ ìˆëŠ” ì§ˆë¬¸ ë°©ë²•ì„ ì œì•ˆí•˜ë©° (ì£¼ì œ ì´íƒˆì‹œ ì£¼ì œë¡œ ëŒì•„ê°€ëŠ” ê°€ì´ë“œ í¬í•¨)
            3. '{topic}' ì£¼ì œì™€ ê´€ë ¨ëœ ë‹¤ìŒ ë‹¨ê³„ì˜ ë°©í–¥ì„±ì„ ì œì‹œí•´ì£¼ì„¸ìš”.
            
            ì¤‘í•™ìƒ ìˆ˜ì¤€ì— ë§ëŠ” ì–¸ì–´ë¡œ í•™ìƒì˜ ì§ˆë¬¸ ìŠ¤í‚¬ê³¼ ì‚¬ê³  ê³¼ì •ì— ì´ˆì ì„ ë§ì¶° í”¼ë“œë°±ì„ ì œê³µí•˜ì„¸ìš”.
            """
            
            response = self.client.chat.completions.create(
                model="gpt-4o-mini",
                messages=[
                    {"role": "system", "content": self.system_prompt},
                    {"role": "user", "content": analysis_prompt}
                ],
                max_tokens=800,
                temperature=0.7
            )
            
            feedback = response.choices[0].message.content
            
            # í”¼ë“œë°±ì„ êµ¬ì¡°í™”ëœ í˜•íƒœë¡œ íŒŒì‹±
            return self._parse_feedback(feedback)
            
        except Exception as e:
            return {
                "strengths": "ì¢‹ì€ ì§ˆë¬¸ì„ í–ˆì–´ìš”! ğŸ‘",
                "improvements": "ë” êµ¬ì²´ì ìœ¼ë¡œ ì„¤ëª…í•´ë³´ë©´ ì–´ë–¨ê¹Œìš”?",
                "next_steps": "ì´ ì£¼ì œì— ëŒ€í•´ ë” íƒêµ¬í•´ë³´ì„¸ìš”!",
                "suggested_questions": ["ì´ ì£¼ì œì—ì„œ ê°€ì¥ ê¶ê¸ˆí•œ ì ì´ ë¬´ì—‡ì¸ê°€ìš”?"],
                "error": str(e),
                "raw_feedback": f"ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {str(e)}"
            }
    
    def _parse_feedback(self, feedback_text: str) -> Dict[str, any]:
        """í”¼ë“œë°± í…ìŠ¤íŠ¸ë¥¼ êµ¬ì¡°í™”ëœ ë”•ì…”ë„ˆë¦¬ë¡œ ë³€í™˜"""
        import re
        
        result = {
            "strengths": "",
            "improvements": "",
            "next_steps": "",
            "suggested_questions": [],
            "raw_feedback": feedback_text
        }
        
        # ë” ê°•ê±´í•œ íŒŒì‹±ì„ ìœ„í•´ ì •ê·œì‹ ì‚¬ìš©
        text = feedback_text.strip()
        
        # ê° ì„¹ì…˜ ì¶”ì¶œ
        sections = {
            "strengths": r"(\*\*ì˜í•œ ì \*\*|ì˜í•œ ì )[:ï¼š]?\s*(.*?)(?=\*\*ê°œì„ í•  ì \*\*|ê°œì„ í•  ì |ë‹¤ìŒ ë‹¨ê³„|\*\*ë‹¤ìŒ ë‹¨ê³„\*\*|ì¶”ì²œ ì§ˆë¬¸|\*\*ì¶”ì²œ ì§ˆë¬¸\*\*|$)",
            "improvements": r"(\*\*ê°œì„ í•  ì \*\*|ê°œì„ í•  ì )[:ï¼š]?\s*(.*?)(?=\*\*ë‹¤ìŒ ë‹¨ê³„\*\*|ë‹¤ìŒ ë‹¨ê³„|ì¶”ì²œ ì§ˆë¬¸|\*\*ì¶”ì²œ ì§ˆë¬¸\*\*|$)",
            "next_steps": r"(\*\*ë‹¤ìŒ ë‹¨ê³„\*\*|ë‹¤ìŒ ë‹¨ê³„)[:ï¼š]?\s*(.*?)(?=ì¶”ì²œ ì§ˆë¬¸|\*\*ì¶”ì²œ ì§ˆë¬¸\*\*|$)",
            "questions": r"(\*\*ì¶”ì²œ ì§ˆë¬¸\*\*|ì¶”ì²œ ì§ˆë¬¸)[:ï¼š]?\s*(.*?)$"
        }
        
        for key, pattern in sections.items():
            match = re.search(pattern, text, re.DOTALL | re.IGNORECASE)
            if match and match.group(2):
                content = match.group(2).strip()
                
                if key == "questions":
                    # ì§ˆë¬¸ íŒŒì‹±: ë²ˆí˜¸ë‚˜ ëŒ€ì‹œë¡œ ì‹œì‘í•˜ëŠ” ë¼ì¸ë“¤ì„ ì°¾ìŒ
                    questions = []
                    for line in content.split('\n'):
                        line = line.strip()
                        if not line:
                            continue
                        # ë²ˆí˜¸ë‚˜ ëŒ€ì‹œ ì œê±°
                        if re.match(r'^[\d\-\â€¢]\.\s*', line):
                            question = re.sub(r'^[\d\-\â€¢]\.\s*', '', line)
                            questions.append(question.strip())
                        elif re.match(r'^[\-\â€¢]\s*', line):
                            question = re.sub(r'^[\-\â€¢]\s*', '', line)
                            questions.append(question.strip())
                        elif line and not any(x in line.lower() for x in ['ì˜í•œ ì ', 'ê°œì„ í•  ì ', 'ë‹¤ìŒ ë‹¨ê³„']):
                            questions.append(line)
                    
                    # ë¹ˆ ì§ˆë¬¸ì´ë‚˜ ë„ˆë¬´ ì§§ì€ ì§ˆë¬¸ ì œê±°
                    result["suggested_questions"] = [q for q in questions if len(q) > 3][:3]
                else:
                    # í…ìŠ¤íŠ¸ì—ì„œ ë¶ˆí•„ìš”í•œ ë§ˆí¬ë‹¤ìš´ ì œê±°
                    content = re.sub(r'\*\*([^*]+)\*\*', r'\1', content)
                    content = re.sub(r'[\-\â€¢]\s*', '', content)
                    content = ' '.join(content.split())  # ì—¬ëŸ¬ ê³µë°±ì„ í•˜ë‚˜ë¡œ
                    result[key] = content
        
        # ë¹ˆ í•„ë“œì— ëŒ€í•œ ê¸°ë³¸ê°’ ì„¤ì •
        if not result["strengths"]:
            result["strengths"] = "ì¢‹ì€ ì§ˆë¬¸ì„ í–ˆì–´ìš”!"
        
        if not result["improvements"]:
            result["improvements"] = "ë” êµ¬ì²´ì ìœ¼ë¡œ ì„¤ëª…í•´ë³´ë©´ ì–´ë–¨ê¹Œìš”?"
            
        if not result["next_steps"]:
            result["next_steps"] = "ì´ ì£¼ì œì— ëŒ€í•´ ë” íƒêµ¬í•´ë³´ì„¸ìš”!"
            
        if not result["suggested_questions"]:
            result["suggested_questions"] = ["ì´ ì£¼ì œì—ì„œ ê°€ì¥ ê¶ê¸ˆí•œ ì ì´ ë¬´ì—‡ì¸ê°€ìš”?"]
        
        return result

tutor_service = TutorService()